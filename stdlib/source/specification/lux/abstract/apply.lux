(.require
 [library
  [lux (.except)
   [abstract
    [monad (.only do)]]
   [control
    ["[0]" function]]
   [math
    ["[0]" random (.only Random)]
    [number
     ["n" nat]]]
   [meta
    ["[0]" type]]
   [test
    ["_" property (.only Test)]]]]
 [\\library
  ["[0]" / (.only Apply)]]
 [//
  ["[0]S" functor (.only Injection Comparison)]])

(def .public (spec injection comparison it)
  (All (_ f) (-> (Injection f) (Comparison f) (Apply f) Test))
  (<| (_.for [/.Apply])
      (type.let [:$/1: (-> Nat Nat)])
      (do [! random.monad]
        [sample random.nat
         increase (is (Random :$/1:)
                      (of ! each n.+ random.nat))
         decrease (is (Random :$/1:)
                      (of ! each n.- random.nat))])
      (all _.and
           (_.for [/.functor]
                  (functorS.spec injection comparison (the /.functor it)))

           (_.coverage [/.on]
             (let [(open "/#[0]") it

                   identity!
                   ((comparison n.=)
                    (/#on (injection sample)
                          (injection function.identity))
                    (injection sample))

                   homomorphism!
                   ((comparison n.=)
                    (/#on (injection sample) (injection increase))
                    (injection (increase sample)))
                   
                   interchange!
                   ((comparison n.=) (/#on (injection sample) (injection increase))
                    (/#on (injection increase) (injection (is (-> (-> Nat Nat) Nat)
                                                              (function (_ f) (f sample))))))
                   
                   composition!
                   ((comparison n.=)
                    (|> (injection (is (-> :$/1: :$/1: :$/1:)
                                       function.composite))
                        (/#on (injection increase))
                        (/#on (injection decrease))
                        (/#on (injection sample)))
                    (/#on (/#on (injection sample)
                                (injection increase))
                          (injection decrease)))]
               (and identity!
                    homomorphism!
                    interchange!
                    composition!)))
           )))
