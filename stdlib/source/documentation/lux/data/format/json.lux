(.require
 [library
  [lux (.except)
   ["$" documentation]
   [data
    [text (.only \n)
     ["%" \\format (.only format)]]]
   [meta
    [macro
     ["[0]" template]]]]]
 ["[0]" \\parser]
 [\\library
  ["[0]" /]])

(`` (.def \\parser
      (.List $.Module)
      ($.module \\parser._
                ""
                [($.default \\parser.unconsumed_input)
                 ($.default \\parser.empty_input)
                 ($.default \\parser.unexpected_value)
                 ($.default \\parser.value_mismatch)

                 ($.documentation (\\parser.Parser it)
                   "A JSON parser.")

                 ($.documentation \\parser.result
                   (format "Executes the parser against a JSON object."
                           \n "Verifies that all of the JSON was consumed by the parser.")
                   [(result parser json)])

                 ($.documentation \\parser.any
                   "Just returns the JSON input without applying any logic.")

                 (,, (with_template [<name>]
                       [(`` ($.documentation <name>
                              (format "Reads a JSON value as " (,, (template.text [<name>])) ".")))]

                       [\\parser.null]
                       [\\parser.boolean]
                       [\\parser.number]
                       [\\parser.string]
                       ))

                 (,, (with_template [<test> <check> <read>]
                       [(`` ($.documentation <test>
                              (format "Asks whether a JSON value is a " (,, (template.text [<read>])) ".")))
                        (`` ($.documentation <check>
                              (format "Ensures a JSON value is a " (,, (template.text [<read>])) ".")))]

                       [\\parser.boolean? \\parser.this_boolean ..boolean]
                       [\\parser.number?  \\parser.this_number  ..number]
                       [\\parser.string?  \\parser.this_string  ..string]
                       ))

                 ($.documentation \\parser.nullable
                   "Enhances parser by adding NULL-handling."
                   [(nullable parser)])

                 ($.documentation \\parser.array
                   "Parses the contents of a JSON array."
                   [(array parser)])

                 ($.documentation \\parser.object
                   (format "Parses the contents of a JSON object."
                           \n "Use this with the 'field' combinator.")
                   [(object parser)])

                 ($.documentation \\parser.field
                   (format "Parses a field inside a JSON object."
                           \n "Use this inside the 'object' combinator.")
                   [(field field_name parser)])

                 ($.documentation \\parser.dictionary
                   "Parses a dictionary-like JSON object.")]
                [])))

(`` (.def .public documentation
      (.List $.Module)
      ($.module /._
                (format "Functionality for reading and writing values in the JSON format."
                        \n "For more information, please see: http://www.json.org/")
                [($.default /.Null)
                 ($.default /.Boolean)
                 ($.default /.Number)
                 ($.default /.String)
                 ($.default /.JSON)
                 ($.default /.Array)
                 ($.default /.Object)
                 ($.default /.null?)
                 ($.default /.object)
                 ($.default /.equivalence)
                 ($.default /.format)
                 ($.default /.codec)

                 ($.documentation /.json
                   "A simple way to produce JSON literals."
                   ["null"
                    (json #null)]
                   ["true"
                    (json #1)]
                   ["123.456"
                    (json +123.456)]
                   ["'this is a string'"
                    (json "this is a string")]
                   ["['this' 'is' 'an' 'array']"
                    (json ["this" "is" "an" "array"])]
                   ["{'this' 'is', 'an' 'object'}"
                    (json {"this" "is" "an" "object"})])

                 ($.documentation /.fields
                   "Get all the fields in a JSON object."
                   [(fields json)])

                 ($.documentation /.field
                   "A JSON object field getter."
                   [(field key json)])

                 ($.documentation /.has
                   "A JSON object field setter."
                   [(has key value json)])

                 (,, (with_template [<name> <desc>]
                       [($.documentation <name>
                          (format "A JSON object field getter for " <desc> "."))]

                       [/.boolean_field "booleans"]
                       [/.number_field  "numbers"]
                       [/.string_field  "strings"]
                       [/.array_field   "arrays"]
                       [/.object_field  "objects"]
                       ))]
                [..\\parser])))
