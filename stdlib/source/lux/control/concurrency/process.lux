(.module:
  [lux #*
   ["@" target]
   ["." host (#+ import: object)]
   [abstract
    ["." monad (#+ do)]]
   [control
    ["ex" exception (#+ exception:)]
    ["." io (#+ IO io)]]
   [data
    [collection
     ["." list]]]]
  [//
   ["." atom (#+ Atom)]])

(`` (for {(~~ (static @.old))
          (as-is (import: #long java/lang/Object)

                 (import: #long java/lang/Runtime
                   (#static getRuntime [] java/lang/Runtime)
                   (availableProcessors [] int))

                 (import: #long java/lang/Runnable)

                 (import: #long java/util/concurrent/TimeUnit
                   (#enum MILLISECONDS))
                 
                 (import: #long java/util/concurrent/Executor
                   (execute [java/lang/Runnable] #io void))

                 (import: #long (java/util/concurrent/ScheduledFuture a))

                 (import: #long java/util/concurrent/ScheduledThreadPoolExecutor
                   (new [int])
                   (schedule [java/lang/Runnable long java/util/concurrent/TimeUnit] #io (java/util/concurrent/ScheduledFuture java/lang/Object))))

          (~~ (static @.jvm))
          (as-is (import: #long java/lang/Object)

                 (import: #long java/lang/Runtime
                   (#static getRuntime [] java/lang/Runtime)
                   (availableProcessors [] int))

                 (import: #long java/lang/Runnable)

                 (import: #long java/util/concurrent/TimeUnit
                   (#enum MILLISECONDS))
                 
                 (import: #long java/util/concurrent/Executor
                   (execute [java/lang/Runnable] #io void))

                 (import: #long (java/util/concurrent/ScheduledFuture a))

                 (import: #long java/util/concurrent/ScheduledThreadPoolExecutor
                   (new [int])
                   (schedule [java/lang/Runnable long java/util/concurrent/TimeUnit] #io (java/util/concurrent/ScheduledFuture java/lang/Object))))}
         
         ## Default
         (type: Process
           {#creation Nat
            #delay Nat
            #action (IO Any)})
         ))

(def: #export parallelism
  Nat
  (`` (for {(~~ (static @.old))
            (|> (java/lang/Runtime::getRuntime)
                (java/lang/Runtime::availableProcessors)
                .nat)

            (~~ (static @.jvm))
            (|> (java/lang/Runtime::getRuntime)
                (java/lang/Runtime::availableProcessors)
                (:coerce Nat))}
           
           ## Default
           1)))

(def: runner
  (`` (for {(~~ (static @.old))
            (java/util/concurrent/ScheduledThreadPoolExecutor::new (.int ..parallelism))

            (~~ (static @.jvm))
            (java/util/concurrent/ScheduledThreadPoolExecutor::new (.int ..parallelism))}
           
           ## Default
           (: (Atom (List Process))
              (atom.atom (list))))))

(def: #export (schedule milli-seconds action)
  (-> Nat (IO Any) (IO Any))
  (`` (for {(~~ (static @.old))
            (let [runnable (object [] [java/lang/Runnable]
                             []
                             (java/lang/Runnable [] (run self) void
                                                 (io.run action)))]
              (case milli-seconds
                0 (java/util/concurrent/Executor::execute runnable runner)
                _ (java/util/concurrent/ScheduledThreadPoolExecutor::schedule runnable (.int milli-seconds) java/util/concurrent/TimeUnit::MILLISECONDS
                                                                              runner)))

            (~~ (static @.jvm))
            (let [runnable (object [] [java/lang/Runnable]
                             []
                             (java/lang/Runnable [] (run self) void
                                                 (io.run action)))]
              (case milli-seconds
                0 (java/util/concurrent/Executor::execute runnable runner)
                _ (java/util/concurrent/ScheduledThreadPoolExecutor::schedule runnable (.int milli-seconds) java/util/concurrent/TimeUnit::MILLISECONDS
                                                                              runner)))}
           
           ## Default
           (atom.update (|>> (#.Cons {#creation ("lux io current-time")
                                      #delay milli-seconds
                                      #action action}))
                        runner))))

(`` (for {(~~ (static @.old))
          (as-is)

          (~~ (static @.jvm))
          (as-is)}
         
         ## Default
         (as-is (exception: #export cannot-continue-running-processes)
                
                (def: #export run!
                  (IO Any)
                  (loop [_ []]
                    (do io.monad
                      [processes (atom.read runner)]
                      (case processes
                        ## And... we're done!
                        #.Nil
                        (wrap [])

                        _
                        (do @
                          [#let [now ("lux io current-time")
                                 [ready pending] (list.partition (function (_ process)
                                                                   (|> (get@ #creation process)
                                                                       (n/+ (get@ #delay process))
                                                                       (n/<= now)))
                                                                 processes)]
                           swapped? (atom.compare-and-swap! processes pending runner)]
                          (if swapped?
                            (monad.seq @ ready)
                            (error! (ex.construct cannot-continue-running-processes []))))
                        ))))
                )))
