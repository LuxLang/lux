(.module:
  [lux #*
   [abstract
    ["." monad (#+ do)]]
   [data
    [collection
     ["." list]]]
   [target
    ["_" php (#+ Expression)]]]
  ["." // #_
   ["#." runtime (#+ Operation Phase Generator)]
   ["#." primitive]
   ["///#" //// #_
    [analysis (#+ Variant Tuple)]
    ["#." synthesis (#+ Synthesis)]
    ["//#" /// #_
     ["#." phase ("#\." monad)]]]])

(def: #export (tuple generate archive elemsS+)
  (Generator (Tuple Synthesis))
  (case elemsS+
    #.Nil
    (///////phase\wrap (//primitive.text /////synthesis.unit))

    (#.Cons singletonS #.Nil)
    (generate archive singletonS)

    _
    (let [size (_.int (.int (list.size elemsS+)))]
      (|> elemsS+
          (monad.map ///////phase.monad (generate archive))
          ## (///////phase\map (|>> (list& (_.key_value (_.string //runtime.tuple_size_field) size))
          ##                        _.array/*))
          (///////phase\map (|>> _.array/*
                                 (//runtime.tuple//make size)))))))

(def: #export (variant generate archive [lefts right? valueS])
  (Generator (Variant Synthesis))
  (let [tag (if right?
              (inc lefts)
              lefts)]
    (///////phase\map (//runtime.variant tag right?)
                      (generate archive valueS))))
