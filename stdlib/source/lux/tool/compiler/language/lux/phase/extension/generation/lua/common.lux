(.module:
  [lux #*
   [abstract
    ["." monad (#+ do)]]
   [control
    ["." function]]
   [data
    ["." product]
    [collection
     ["." dictionary]]]
   [math
    [number
     ["f" frac]]]
   [target
    ["_" lua (#+ Expression Literal)]]]
  [////
   ["/" bundle]
   [//
    [generation
     [extension (#+ Nullary Unary Binary Trinary
                    nullary unary binary trinary)]
     ["//" lua #_
      ["#." runtime (#+ Operation Phase Handler Bundle)]]]]])

(template: (!unary function)
  (|>> list _.apply/* (|> (_.var function))))

(def: lux_procs
  Bundle
  (|> /.empty
      (/.install "is" (binary (product.uncurry _.=)))
      (/.install "try" (unary //runtime.lux//try))))

(def: i64_procs
  Bundle
  (<| (/.prefix "i64")
      (|> /.empty
          (/.install "and" (binary (product.uncurry _.bit_and)))
          (/.install "or" (binary (product.uncurry _.bit_or)))
          (/.install "xor" (binary (product.uncurry _.bit_xor)))
          (/.install "left-shift" (binary (product.uncurry _.bit_shl)))
          (/.install "right-shift" (binary (product.uncurry //runtime.i64//right_shift)))
          (/.install "=" (binary (product.uncurry _.=)))
          (/.install "+" (binary (product.uncurry _.+)))
          (/.install "-" (binary (product.uncurry _.-)))
          (/.install "<" (binary (product.uncurry _.<)))
          (/.install "*" (binary (product.uncurry _.*)))
          (/.install "/" (binary (product.uncurry _.//)))
          (/.install "%" (binary (product.uncurry _.%)))
          (/.install "f64" (unary (_./ (_.float +1.0))))
          (/.install "char" (unary (!unary "string.char")))
          )))

(def: f64//decode
  (Unary Expression)
  (|>> list _.apply/* (|> (_.var "tonumber")) _.return (_.closure (list)) //runtime.lux//try))

(def: f64_procs
  Bundle
  (<| (/.prefix "f64")
      (|> /.empty
          (/.install "+" (binary (product.uncurry _.+)))
          (/.install "-" (binary (product.uncurry _.-)))
          (/.install "*" (binary (product.uncurry _.*)))
          (/.install "/" (binary (product.uncurry _./)))
          (/.install "%" (binary (product.uncurry _.%)))
          (/.install "=" (binary (product.uncurry _.=)))
          (/.install "<" (binary (product.uncurry _.<)))
          (/.install "i64" (unary (!unary "math.floor")))
          (/.install "encode" (unary (!unary "tostring")))
          (/.install "decode" (unary ..f64//decode)))))

(def: (text//char [subjectO paramO])
  (Binary Expression)
  (//runtime.text//char subjectO paramO))

(def: (text//clip [paramO extraO subjectO])
  (Trinary Expression)
  (//runtime.text//clip subjectO paramO extraO))

(def: (text//index [startO partO textO])
  (Trinary Expression)
  (//runtime.text//index textO partO startO))

(def: text_procs
  Bundle
  (<| (/.prefix "text")
      (|> /.empty
          (/.install "=" (binary (product.uncurry _.=)))
          (/.install "<" (binary (product.uncurry _.<)))
          (/.install "concat" (binary (product.uncurry (function.flip _.concat))))
          (/.install "index" (trinary text//index))
          (/.install "size" (unary (|>> list _.apply/* (|> (_.var "string.len")))))
          (/.install "char" (binary (product.uncurry //runtime.text//char)))
          (/.install "clip" (trinary text//clip))
          )))

(def: (io//log! messageO)
  (Unary Expression)
  (|> (_.apply/* (list messageO) (_.var "print"))
      (_.or //runtime.unit)))

(def: io_procs
  Bundle
  (<| (/.prefix "io")
      (|> /.empty
          (/.install "log" (unary ..io//log!))
          (/.install "error" (unary (!unary "error")))
          (/.install "current-time" (nullary (function (_ _)
                                               (|> (_.var "os.time")
                                                   (_.apply/* (list))
                                                   (_.* (_.int +1,000)))))))))

(def: #export bundle
  Bundle
  (<| (/.prefix "lux")
      (|> lux_procs
          (dictionary.merge i64_procs)
          (dictionary.merge f64_procs)
          (dictionary.merge text_procs)
          (dictionary.merge io_procs)
          )))
