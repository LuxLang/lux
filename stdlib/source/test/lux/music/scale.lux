... This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
... If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.

(.require
 [library
  [lux (.except)
   [abstract
    [monad (.only do)]
    ["[0]" equivalence
     ["[1]T" \\test]]
    ["[0]" hash
     ["[1]T" \\test]]]
   [control
    ["|" pipe]
    ["[0]" try (.use "[1]#[0]" functor)]
    ["[0]" exception]]
   [data
    [collection
     ["[0]" list]
     ["[0]" set]]]
   [math
    ["[0]" random (.only Random) (.use "[1]#[0]" monad)]
    [number
     ["[0]" nat (.use "[1]#[0]" equivalence)]]]
   [test
    ["_" property (.only Test)]]]]
 [\\library
  ["[0]" /]
  [//
   ["[0]" interval (.only)
    ["[1]T" \\test]]]])

(def .public random
  (Random /.Scale)
  (all random.either
       (random#in /.chromatic)

       (random#in /.major_pentatonic)
       (random#in /.suspended_pentatonic)
       (random#in /.blues_minor)
       (random#in /.blues_major)
       (random#in /.minor_pentatonic)

       (random#in /.whole_tone)

       (random#in /.major)
       (random#in /.minor)
       (random#in /.persian)
       
       (random#in /.octatonic)
       ))

(with_expansions [<options> (these /.chromatic

                                   /.major_pentatonic
                                   /.suspended_pentatonic
                                   /.blues_minor
                                   /.blues_major
                                   /.minor_pentatonic

                                   /.whole_tone

                                   /.major
                                   /.minor
                                   /.persian
                                   
                                   /.octatonic
                                   )]
  (def .public test
    Test
    (<| (_.covering /._)
        (do [! random.monad]
          [expected ..random
           interval (random.only (|>> (nat.= interval.perfect_unison)
                                      not)
                                 intervalT.random)])
        (_.for [/.Scale])
        (`` (all _.and
                 (_.for [/.equivalence]
                        (equivalenceT.spec /.equivalence ..random))
                 (_.for [/.hash]
                        (hashT.spec /.hash ..random))

                 (_.coverage [/.intervals /.scale]
                   (|> expected
                       /.intervals
                       /.scale
                       (try#each (of /.equivalence = expected))
                       (try.else false)))
                 (_.coverage [/.not_an_octave]
                   (|> expected
                       /.intervals
                       (list.partial interval)
                       /.scale
                       (|.when
                         {try.#Failure error}
                         (exception.match? /.not_an_octave error)

                         _
                         false)))
                 (_.coverage [/.has_perfect_unison]
                   (|> expected
                       /.intervals
                       (list.partial interval.perfect_unison)
                       /.scale
                       (|.when
                         {try.#Failure error}
                         (exception.match? /.has_perfect_unison error)

                         _
                         false)))
                 (_.coverage [<options>]
                   (let [options (is (List /.Scale)
                                     (list <options>))
                         uniques (set.of_list /.hash options)]
                     (nat#= (list.size options)
                            (set.size uniques))))
                 (,, (with_template [<original> <alternative>]
                       [(_.coverage [<alternative>]
                          (same? <original>
                                 <alternative>))]

                       [/.suspended_pentatonic /.egyptian]
                       ))
                 )))))
