(.module:
  [lux #*
   ["_" test (#+ Test)]
   [abstract
    [monad (#+ do)]
    {[0 #spec]
     [/
      ["$." codec]]}]
   [control
    ["." try]]
   [data
    ["." maybe]
    ["." text ("#\." equivalence)]
    [number
     ["n" nat]]
    [collection
     ["." list ("#\." functor)]
     ["." set]]]
   [macro
    ["." template]]
   [math
    ["." random (#+ Random)]]]
  {1
   ["." /]})

(with-expansions [<encodings> (as-is [all/a
                                      [/.ascii]]

                                     [all/ibm<1000
                                      [/.ibm-37
                                       /.ibm-273
                                       /.ibm-277
                                       /.ibm-278
                                       /.ibm-280
                                       /.ibm-284
                                       /.ibm-285
                                       /.ibm-290
                                       /.ibm-297
                                       /.ibm-300
                                       /.ibm-420
                                       /.ibm-424
                                       /.ibm-437
                                       /.ibm-500
                                       /.ibm-737
                                       /.ibm-775
                                       /.ibm-833
                                       /.ibm-834
                                       /.ibm-838
                                       /.ibm-850
                                       /.ibm-852
                                       /.ibm-855
                                       /.ibm-856
                                       /.ibm-857
                                       /.ibm-858
                                       /.ibm-860
                                       /.ibm-861
                                       /.ibm-862
                                       /.ibm-863
                                       /.ibm-864
                                       /.ibm-865
                                       /.ibm-866
                                       /.ibm-868
                                       /.ibm-869
                                       /.ibm-870
                                       /.ibm-871
                                       /.ibm-874
                                       /.ibm-875
                                       /.ibm-918
                                       /.ibm-921
                                       /.ibm-922
                                       /.ibm-930
                                       /.ibm-933
                                       /.ibm-935
                                       /.ibm-937
                                       /.ibm-939
                                       /.ibm-942
                                       /.ibm-942c
                                       /.ibm-943
                                       /.ibm-943c
                                       /.ibm-948
                                       /.ibm-949
                                       /.ibm-949c
                                       /.ibm-950
                                       /.ibm-964
                                       /.ibm-970]]

                                     [all/ibm>1000
                                      [/.ibm-1006
                                       /.ibm-1025
                                       /.ibm-1026
                                       /.ibm-1046
                                       /.ibm-1047
                                       /.ibm-1097
                                       /.ibm-1098
                                       /.ibm-1112
                                       /.ibm-1122
                                       /.ibm-1123
                                       /.ibm-1124
                                       /.ibm-1140
                                       /.ibm-1141
                                       /.ibm-1142
                                       /.ibm-1143
                                       /.ibm-1144
                                       /.ibm-1145
                                       /.ibm-1146
                                       /.ibm-1147
                                       /.ibm-1148
                                       /.ibm-1149
                                       /.ibm-1166
                                       /.ibm-1364
                                       /.ibm-1381
                                       /.ibm-1383
                                       /.ibm-33722]]
                                     
                                     [all/iso
                                      [/.iso-2022-cn
                                       /.iso2022-cn-cns
                                       /.iso2022-cn-gb
                                       /.iso-2022-jp
                                       /.iso-2022-jp-2
                                       /.iso-2022-kr
                                       /.iso-8859-1
                                       /.iso-8859-2
                                       /.iso-8859-3
                                       /.iso-8859-4
                                       /.iso-8859-5
                                       /.iso-8859-6
                                       /.iso-8859-7
                                       /.iso-8859-8
                                       /.iso-8859-9
                                       /.iso-8859-11
                                       /.iso-8859-13
                                       /.iso-8859-15]]

                                     [all/mac
                                      [/.mac-arabic
                                       /.mac-central-europe
                                       /.mac-croatian
                                       /.mac-cyrillic
                                       /.mac-dingbat
                                       /.mac-greek
                                       /.mac-hebrew
                                       /.mac-iceland
                                       /.mac-roman
                                       /.mac-romania
                                       /.mac-symbol
                                       /.mac-thai
                                       /.mac-turkish
                                       /.mac-ukraine]]
                                     
                                     [all/utf
                                      [/.utf-8
                                       /.utf-16
                                       /.utf-32]]

                                     [all/windows
                                      [/.windows-31j
                                       /.windows-874
                                       /.windows-949
                                       /.windows-950
                                       /.windows-1250
                                       /.windows-1252
                                       /.windows-1251
                                       /.windows-1253
                                       /.windows-1254
                                       /.windows-1255
                                       /.windows-1256
                                       /.windows-1257
                                       /.windows-1258
                                       /.windows-iso2022jp
                                       /.windows-50220
                                       /.windows-50221]]
                                     
                                     [all/others
                                      [/.cesu-8
                                       /.koi8-r
                                       /.koi8-u]]
                                     )
                  <named> (template [<definition> <by-letter>]
                            [((: (-> Any (List /.Encoding))
                                 (function (_ _)
                                   (`` (list (~~ (template.splice <by-letter>))))))
                              123)]
                            
                            <encodings>)]
  (def: all-encodings
    (list.concat (list <named>)))
  
  (def: unique-encodings
    (set.from-list text.hash (list\map /.name ..all-encodings)))

  (def: verdict
    (n.= (list.size ..all-encodings)
         (set.size ..unique-encodings)))

  (template [<definition> <by-letter>]
    [(def: <definition>
       Test
       (`` (_.cover [/.name (~~ (template.splice <by-letter>))]
                    ..verdict)))]
    
    <encodings>)

  (def: #export random
    (Random /.Encoding)
    (let [options (list.size ..all-encodings)]
      (do {! random.monad}
        [choice (\ ! map (n.% options) random.nat)]
        (wrap (maybe.assume (list.nth choice ..all-encodings))))))

  (def: #export test
    Test
    (<| (_.covering /._)
        (_.for [/.Encoding])
        (`` ($_ _.and
                (_.for [/.utf8]
                       ($codec.spec text.equivalence /.utf8 (random.unicode 5)))
                
                (~~ (template [<definition> <by-letter>]
                      [<definition>]
                      
                      <encodings>))
                ))))
  )
