(.module:
  [lux #*
   data/text/format
   ["_" test (#+ Test)]
   [control
    pipe
    codec
    [monad (#+ do Monad)]
    [equivalence (#+ Equivalence)]
    ["p" parser]
    {[0 #test]
     [/
      ["$." equivalence]
      ["$." codec]]}]
   [data
    ["." error]
    ["." bit]
    ["." maybe]
    ["." text]
    [number
     ["." frac]]
    [collection
     [row (#+ row)]
     ["d" dictionary]
     ["." list]]]
   [macro
    [poly (#+ derived:)]
    ["." poly/equivalence]
    ["." poly/json]]
   [type
    ["." unit]]
   [math
    ["r" random (#+ Random)]]
   [time
    ["ti" instant]
    ["tda" date]
    ## ["tdu" duration]
    ]]
  [test
   [lux
    [time
     ["_." instant]
     ## ["_." duration]
     ["_." date]]]]
  {1
   ["." / (#+ JSON)]}
  )

(def: #export json
  (Random JSON)
  (r.rec (function (_ json)
           (do r.monad
             [size (:: @ map (n/% 2) r.nat)]
             ($_ r.or
                 (:: @ wrap [])
                 r.bit
                 r.frac
                 (r.unicode size)
                 (r.row size json)
                 (r.dictionary text.hash size (r.unicode size) json)
                 )))))

(def: #export test
  Test
  (<| (_.context (%name (name-of /._)))
      ($_ _.and
          ($equivalence.spec /.equivalence ..json)
          ($codec.spec /.equivalence /.codec ..json)
          )))
