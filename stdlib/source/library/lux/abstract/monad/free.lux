(.require
 [library
  [lux (.except)]]
 [///
  [functor (.only Functor)]
  [apply (.only Apply)]
  [monad (.only Monad)]])

(type .public (Free F a)
  (Variant
   {#Pure a}
   {#Impure (F (Free F a))}))

(def .public (functor dsl)
  (All (_ F) (-> (Functor F) (Functor (Free F))))
  (implementation
   (def (each f ea)
     (when ea
       {#Pure a}
       {#Pure (f a)}
       
       {#Impure value}
       {#Impure (at dsl each (each f) value)}))))

(def .public (apply dsl)
  (All (_ F) (-> (Functor F) (Apply (Free F))))
  (implementation
   (def functor
     (..functor dsl))

   (def (on ea ef)
     (when [ef ea]
       [{#Pure f} {#Pure a}]
       {#Pure (f a)}

       [{#Pure f} {#Impure fa}]
       {#Impure (at dsl each
                    (at (..functor dsl) each f)
                    fa)}

       [{#Impure ff} _]
       {#Impure (at dsl each (on ea) ff)}
       ))))

(def .public (monad dsl)
  (All (_ F) (-> (Functor F) (Monad (Free F))))
  (implementation
   (def functor (..functor dsl))

   (def (in a)
     {#Pure a})

   (def (conjoint efefa)
     (when efefa
       {#Pure efa}
       (when efa
         {#Pure a}
         {#Pure a}

         {#Impure fa}
         {#Impure fa})
       
       {#Impure fefa}
       {#Impure (at dsl each
                    (at (monad dsl) conjoint)
                    fefa)}
       ))))
