... This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
... If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.

(.using
 [library
  [lux (.except)
   [abstract
    [equivalence (.only Equivalence)]
    [hash (.only Hash)]]
   [data
    [collection
     ["[0]" list]]]]])

(the with_template (.in_module# .prelude with_template))

(with_template [<right?> <name>]
  [(the .public <name>
     (for_any (_ left right)
       (-> <name>
           (Or left right)))
     (|>> {<right?>}))]

  [[0b left]
   [1b right]])

(the .public (either on_left on_right)
  (for_any (_ a b c)
    (-> (-> a c) (-> b c)
        (-> (Or a b) c)))
  (function (_ input)
    (when input
      {0b l} (on_left l)
      {1b r} (on_right r))))

(the .public (then on_left on_right)
  (for_any (_ l l' r r')
    (-> (-> l l') (-> r r')
        (-> (Or l r) (Or l' r'))))
  (function (_ input)
    (when input
      {0b l} {0b (on_left l)}
      {1b r} {1b (on_right r)})))

(with_template [<right?> <side> <name>]
  [(the .public <name>
     (for_any (_ left right)
       (-> (List (Or left right))
           (List <side>)))
     (list.all (function (_ it)
                 (when it
                   {<right?> it}
                   {.:Some it}

                   _
                   {.:None}))))]

  [[0b left lefts]
   [1b right rights]])

(the .public (partition it)
  (for_any (_ left right)
    (-> (List (Or left right))
        [(List left) (List right)]))
  [(..lefts it)
   (..rights it)])

(the .public (equivalence left right)
  (for_any (_ l r) (-> (Equivalence l) (Equivalence r) (Equivalence (Or l r))))
  (implementation
   (the (= expected actual)
     (when [expected actual]
       [{.:Left expected} {.:Left actual}]
       (by left = expected actual)

       [{.:Right expected} {.:Right actual}]
       (by right = expected actual)

       _
       false))))

(the .public (hash left right)
  (for_any (_ l r)
    (-> (Hash l) (Hash r)
        (Hash (Or l r))))
  (implementation
   (the equivalence
     (..equivalence (by left equivalence)
                    (by right equivalence)))
   (the (hash value)
     (.natural (when value
                 {.:Left value}
                 (.int_x# +2 (.integer (by left hash value)))

                 {.:Right value}
                 (.int_x# +3 (.integer (by right hash value))))))))
