(.module:
  [library
   [lux #*
    [abstract
     [functor (#+ Functor)]
     [apply (#+ Apply)]
     [monad (#+ Monad)]]
    [type
     abstract]]])

(abstract: .public (Policy brand value label)
  {}

  value

  (type: .public (Can_Upgrade brand label value)
    (-> value (Policy brand value label)))

  (type: .public (Can_Downgrade brand label value)
    (-> (Policy brand value label) value))

  (type: .public (Privilege brand label)
    {#can_upgrade (Can_Upgrade brand label)
     #can_downgrade (Can_Downgrade brand label)})

  (type: .public (Delegation brand from to)
    (All [value]
      (-> (Policy brand value from)
          (Policy brand value to))))

  (def: .public (delegation downgrade upgrade)
    (All [brand from to]
      (-> (Can_Downgrade brand from) (Can_Upgrade brand to)
          (Delegation brand from to)))
    (|>> downgrade upgrade))

  (type: .public (Context brand scope label)
    (-> (Privilege brand label)
        (scope label)))

  (def: privilege
    Privilege
    {#can_upgrade (|>> :abstraction)
     #can_downgrade (|>> :representation)})

  (def: .public (with_policy context)
    (All [brand scope]
      (Ex [label]
        (-> (Context brand scope label)
            (scope label))))
    (context ..privilege))

  (def: (of_policy constructor)
    (-> Type Type)
    (type (All [brand label]
            (constructor (All [value] (Policy brand value label))))))

  (implementation: .public functor
    (:~ (..of_policy Functor))
    
    (def: (map f fa)
      (|> fa :representation f :abstraction)))

  (implementation: .public apply
    (:~ (..of_policy Apply))
    
    (def: &functor ..functor)
    
    (def: (apply ff fa)
      (:abstraction ((:representation ff) (:representation fa)))))

  (implementation: .public monad
    (:~ (..of_policy Monad))
    
    (def: &functor ..functor)
    (def: in (|>> :abstraction))
    (def: join (|>> :representation)))
  )

(template [<brand> <value> <upgrade> <downgrade>]
  [(abstract: .public <brand>
     {}
     
     Any

     (type: .public <value>
       (Policy <brand>))
     
     (type: .public <upgrade>
       (Can_Upgrade <brand>))
     
     (type: .public <downgrade>
       (Can_Downgrade <brand>))
     )]

  [Privacy Private Can_Conceal Can_Reveal]
  [Safety Safe Can_Trust Can_Distrust]
  )
